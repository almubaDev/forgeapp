{% extends 'base.html' %}
{% load static %}

{% block title %}Agenda - ForgeApp{% endblock %}
{% block page_title %}Agenda{% endblock %}
{% block page_subtitle %}{{ selected_date|date:"l, d \d\e F \d\e Y" }}{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Mini Calendario -->
    <div class="lg:col-span-1">
        <div class="card-premium p-4 sticky top-24">
            <!-- Navegación del mes -->
            <div class="flex items-center justify-between mb-4">
                <a href="?month={{ prev_month }}&year={{ prev_year }}&date={{ selected_date|date:'Y-m-d' }}"
                   class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-chevron-left text-dark-500"></i>
                </a>
                <h3 class="text-lg font-display font-bold text-dark-800">{{ month_name }} {{ current_year }}</h3>
                <a href="?month={{ next_month }}&year={{ next_year }}&date={{ selected_date|date:'Y-m-d' }}"
                   class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <i class="fas fa-chevron-right text-dark-500"></i>
                </a>
            </div>

            <!-- Días de la semana -->
            <div class="grid grid-cols-7 gap-1 mb-2">
                {% for day_name in "LMMJVSD" %}
                <div class="text-center text-xs font-semibold text-dark-500 py-1">{{ day_name }}</div>
                {% endfor %}
            </div>

            <!-- Días del mes -->
            {% for week in month_days %}
            <div class="grid grid-cols-7 gap-1">
                {% for day in week %}
                {% if day == 0 %}
                <div class="p-2"></div>
                {% else %}
                {% with day_date=current_year|stringformat:"d"|add:"-"|add:current_month|stringformat:"02d"|add:"-"|add:day|stringformat:"02d" %}
                <a href="?date={{ current_year }}-{{ current_month|stringformat:'02d' }}-{{ day|stringformat:'02d' }}&month={{ current_month }}&year={{ current_year }}"
                   class="p-2 text-center text-sm rounded-lg transition-all relative
                          {% if day == selected_date.day and current_month == selected_date.month and current_year == selected_date.year %}
                              bg-primary-500 text-white font-bold
                          {% elif day == today.day and current_month == today.month and current_year == today.year %}
                              bg-primary-100 text-primary-700 font-semibold
                          {% else %}
                              hover:bg-gray-100 text-dark-700
                          {% endif %}">
                    {{ day }}
                    <!-- Indicadores de estado del día -->
                    <div class="absolute bottom-0.5 left-1/2 transform -translate-x-1/2 flex space-x-0.5">
                        {% for appt_date in days_with_appointments %}
                            {% if appt_date.day == day and appt_date.month == current_month and appt_date.year == current_year %}
                            <span class="w-1.5 h-1.5 rounded-full bg-primary-500" title="Cita agendada"></span>
                            {% endif %}
                        {% endfor %}
                        {% for block_date in days_with_blocks %}
                            {% if block_date.day == day and block_date.month == current_month and block_date.year == current_year %}
                            <span class="w-1.5 h-1.5 rounded-full bg-gray-400" title="Bloqueado"></span>
                            {% endif %}
                        {% endfor %}
                    </div>
                </a>
                {% endwith %}
                {% endif %}
                {% endfor %}
            </div>
            {% endfor %}

            <!-- Botón Ir a Hoy -->
            <div class="mt-4 pt-4 border-t border-gray-100">
                <a href="{% url 'forgeapp:agenda_view' %}"
                   class="block w-full text-center px-4 py-2 bg-primary-500 text-white font-semibold rounded-lg hover:bg-primary-600 transition-colors">
                    <i class="fas fa-calendar-day mr-2"></i>
                    Ir a Hoy
                </a>
            </div>

            <!-- Leyenda Calendario -->
            <div class="mt-4 pt-4 border-t border-gray-100">
                <p class="text-xs font-semibold text-dark-500 mb-2">Indicadores del calendario</p>
                <div class="space-y-1.5 text-xs">
                    <div class="flex items-center space-x-2">
                        <span class="w-2 h-2 rounded-full bg-primary-500"></span>
                        <span class="text-dark-600">Día con citas</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="w-2 h-2 rounded-full bg-gray-400"></span>
                        <span class="text-dark-600">Día con bloqueos</span>
                    </div>
                </div>
            </div>

            <!-- Leyenda Vista Diaria -->
            <div class="mt-3 pt-3 border-t border-gray-100">
                <p class="text-xs font-semibold text-dark-500 mb-2">Vista diaria</p>
                <div class="space-y-1.5 text-xs">
                    <div class="flex items-center space-x-2">
                        <span class="w-3 h-3 rounded bg-green-100 border border-green-500"></span>
                        <span class="text-dark-600">Disponible</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="w-3 h-3 rounded bg-primary-100 border border-primary-500"></span>
                        <span class="text-dark-600">Cita agendada</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="w-3 h-3 rounded bg-gray-200 border border-gray-400"></span>
                        <span class="text-dark-600">Bloqueado</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vista Diaria -->
    <div class="lg:col-span-3">
        <div class="card-premium overflow-hidden">
            <!-- Header del día -->
            <div class="px-6 py-4 bg-gradient-to-r from-primary-500 to-primary-600 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-display font-bold">{{ selected_date|date:"d \d\e F" }}</h2>
                        <p class="text-primary-100">{{ selected_date|date:"l" }}</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <!-- Botón Bloquear/Desbloquear Día Completo -->
                        {% if blocked_slots_count > 0 %}
                        <button onclick="unblockFullDay('{{ selected_date|date:'Y-m-d' }}')"
                                class="px-4 py-2 bg-green-500/80 rounded-lg hover:bg-green-500 transition-colors text-sm font-medium flex items-center space-x-2"
                                title="Desbloquear todos los horarios bloqueados del día">
                            <i class="fas fa-unlock"></i>
                            <span>Desbloquear Día</span>
                        </button>
                        {% else %}
                        <button onclick="blockFullDay('{{ selected_date|date:'Y-m-d' }}')"
                                class="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30 transition-colors text-sm font-medium flex items-center space-x-2"
                                title="Bloquear todos los horarios disponibles del día">
                            <i class="fas fa-ban"></i>
                            <span>Bloquear Día</span>
                        </button>
                        {% endif %}
                        <!-- Navegación -->
                        <div class="flex space-x-2">
                            <a href="?date={{ selected_date|date:'Y-m-d'|add:'-1 day' }}&month={{ current_month }}&year={{ current_year }}"
                               class="p-2 bg-white/20 rounded-lg hover:bg-white/30 transition-colors">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                            <a href="?date={{ selected_date|date:'Y-m-d'|add:'1 day' }}&month={{ current_month }}&year={{ current_year }}"
                               class="p-2 bg-white/20 rounded-lg hover:bg-white/30 transition-colors">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Slots de tiempo -->
            <div class="divide-y divide-gray-100 max-h-[70vh] overflow-y-auto">
                {% for slot in time_slots %}
                <div class="group flex items-stretch hover:bg-gray-50 transition-colors
                            {% if slot.is_default_blocked and not slot.appointment and not slot.is_manually_unblocked %}bg-gray-50{% endif %}">
                    <!-- Hora -->
                    <div class="w-20 flex-shrink-0 px-3 py-3 border-r border-gray-100 text-right">
                        <span class="text-sm font-medium {% if slot.is_default_blocked and not slot.is_manually_unblocked %}text-dark-400{% else %}text-dark-600{% endif %}">{{ slot.time_str }}</span>
                    </div>

                    <!-- Contenido del slot -->
                    <div class="flex-1 px-4 py-2 min-h-[50px]">
                        {% if slot.appointment %}
                            {% if slot.appointment.is_blocked %}
                            <!-- Slot bloqueado manualmente -->
                            <div class="h-full flex items-center justify-between p-2 bg-gray-200 rounded-lg border-l-4 border-gray-500">
                                <span class="text-sm text-dark-500">
                                    <i class="fas fa-lock mr-2"></i>
                                    Bloqueado manualmente
                                </span>
                                <button onclick="toggleBlock('{{ selected_date|date:'Y-m-d' }}', '{{ slot.time_str }}', 'unblock')"
                                        class="px-3 py-1 text-xs bg-red-100 text-red-600 hover:bg-red-200 rounded-lg transition-colors">
                                    <i class="fas fa-unlock mr-1"></i> Desbloquear
                                </button>
                            </div>
                            {% else %}
                            <!-- Cita agendada -->
                            <a href="{% url 'forgeapp:appointment_detail' slot.appointment.pk %}"
                               class="block h-full p-3 bg-primary-50 rounded-lg border-l-4 border-primary-500 hover:bg-primary-100 transition-colors">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="font-semibold text-dark-800">{{ slot.appointment.name }}</h4>
                                        <p class="text-xs text-dark-500">{{ slot.appointment.email }}</p>
                                    </div>
                                    <span class="text-xs text-primary-600">
                                        {{ slot.time_str }} - {{ slot.time_end|time:"H:i" }}
                                    </span>
                                </div>
                            </a>
                            {% endif %}
                        {% elif slot.is_default_blocked %}
                            <!-- Slot bloqueado por defecto (fuera de horario) -->
                            <div class="h-full flex items-center justify-between p-2 rounded-lg border border-dashed border-gray-300">
                                <span class="text-sm text-dark-400">
                                    <i class="fas fa-moon mr-2"></i>
                                    Fuera de horario laboral
                                </span>
                                <button onclick="toggleBlock('{{ selected_date|date:'Y-m-d' }}', '{{ slot.time_str }}', 'enable')"
                                        class="px-3 py-1 text-xs bg-primary-100 text-primary-600 hover:bg-primary-200 rounded-lg transition-colors opacity-0 group-hover:opacity-100">
                                    <i class="fas fa-unlock mr-1"></i> Habilitar
                                </button>
                            </div>
                        {% else %}
                            <!-- Slot disponible -->
                            <div class="h-full flex items-center justify-between p-2 border border-dashed border-green-300 rounded-lg bg-green-50/50">
                                <span class="text-sm text-green-600">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    Disponible
                                </span>
                                <button onclick="toggleBlock('{{ selected_date|date:'Y-m-d' }}', '{{ slot.time_str }}', 'block')"
                                        class="px-3 py-1 text-xs bg-gray-100 text-gray-600 hover:bg-gray-200 rounded-lg transition-colors opacity-0 group-hover:opacity-100">
                                    <i class="fas fa-lock mr-1"></i> Bloquear
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmación Bloquear Día -->
<div id="blockDayModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeBlockDayModal()"></div>
    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden mx-4">
            <!-- Header -->
            <div class="px-6 py-4 bg-gradient-to-r from-red-500 to-red-600">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                        <i class="fas fa-ban text-white text-lg"></i>
                    </div>
                    <h3 class="text-lg font-display font-bold text-white">Bloquear Día Completo</h3>
                </div>
            </div>
            <!-- Body -->
            <div class="p-6">
                <p class="text-dark-700 mb-4">
                    ¿Estás seguro de que deseas bloquear <strong>todos los horarios disponibles</strong> del día <strong id="blockDayDate"></strong>?
                </p>
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4">
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-exclamation-triangle text-amber-500 mt-0.5"></i>
                        <div class="text-sm text-amber-800">
                            <p class="font-semibold mb-1">Esta acción bloqueará:</p>
                            <ul class="list-disc list-inside text-amber-700">
                                <li>Todos los horarios de 9:00 a 20:00</li>
                                <li>Las citas existentes no se verán afectadas</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3">
                <button onclick="closeBlockDayModal()"
                        class="px-4 py-2 text-dark-600 font-medium rounded-lg hover:bg-gray-200 transition-colors">
                    Cancelar
                </button>
                <button onclick="confirmBlockFullDay()"
                        id="confirmBlockBtn"
                        class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition-colors flex items-center space-x-2">
                    <i class="fas fa-lock"></i>
                    <span>Bloquear Día</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Error -->
<div id="errorModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeErrorModal()"></div>
    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden mx-4">
            <!-- Header -->
            <div class="px-6 py-4 bg-gradient-to-r from-red-500 to-red-600">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                        <i class="fas fa-times-circle text-white text-lg"></i>
                    </div>
                    <h3 class="text-lg font-display font-bold text-white">Error</h3>
                </div>
            </div>
            <!-- Body -->
            <div class="p-6">
                <p class="text-dark-700" id="errorMessage">Ha ocurrido un error al procesar la solicitud.</p>
            </div>
            <!-- Footer -->
            <div class="px-6 py-4 bg-gray-50 flex justify-end">
                <button onclick="closeErrorModal()"
                        class="px-4 py-2 bg-primary-500 text-white font-semibold rounded-lg hover:bg-primary-600 transition-colors">
                    Entendido
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmación Desbloquear Día -->
<div id="unblockDayModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeUnblockDayModal()"></div>
    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md">
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden mx-4">
            <!-- Header -->
            <div class="px-6 py-4 bg-gradient-to-r from-green-500 to-green-600">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                        <i class="fas fa-unlock text-white text-lg"></i>
                    </div>
                    <h3 class="text-lg font-display font-bold text-white">Desbloquear Día Completo</h3>
                </div>
            </div>
            <!-- Body -->
            <div class="p-6">
                <p class="text-dark-700 mb-4">
                    ¿Estás seguro de que deseas desbloquear <strong>todos los horarios bloqueados</strong> del día <strong id="unblockDayDate"></strong>?
                </p>
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-info-circle text-green-500 mt-0.5"></i>
                        <div class="text-sm text-green-800">
                            <p class="font-semibold mb-1">Esta acción desbloqueará:</p>
                            <ul class="list-disc list-inside text-green-700">
                                <li>Todos los horarios bloqueados manualmente</li>
                                <li>Las citas existentes no se verán afectadas</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Footer -->
            <div class="px-6 py-4 bg-gray-50 flex justify-end space-x-3">
                <button onclick="closeUnblockDayModal()"
                        class="px-4 py-2 text-dark-600 font-medium rounded-lg hover:bg-gray-200 transition-colors">
                    Cancelar
                </button>
                <button onclick="confirmUnblockFullDay()"
                        id="confirmUnblockBtn"
                        class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-colors flex items-center space-x-2">
                    <i class="fas fa-unlock"></i>
                    <span>Desbloquear Día</span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let pendingBlockDate = null;
let pendingUnblockDate = null;

function toggleBlock(date, time, action) {
    fetch('{% url "forgeapp:toggle_slot_block" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `date=${date}&time=${time}&action=${action}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.status) {
            location.reload();
        } else if (data.error) {
            showError(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showError('Error al procesar la solicitud');
    });
}

function blockFullDay(date) {
    pendingBlockDate = date;
    // Formatear fecha para mostrar
    const dateObj = new Date(date + 'T12:00:00');
    const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
    const formattedDate = dateObj.toLocaleDateString('es-CL', options);
    document.getElementById('blockDayDate').textContent = formattedDate;
    document.getElementById('blockDayModal').classList.remove('hidden');
}

function closeBlockDayModal() {
    document.getElementById('blockDayModal').classList.add('hidden');
    pendingBlockDate = null;
}

function confirmBlockFullDay() {
    if (!pendingBlockDate) return;

    const btn = document.getElementById('confirmBlockBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Bloqueando...</span>';

    fetch('{% url "forgeapp:block_full_day" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `date=${pendingBlockDate}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else if (data.error) {
            closeBlockDayModal();
            showError(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        closeBlockDayModal();
        showError('Error al procesar la solicitud');
    });
}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorModal').classList.remove('hidden');
}

function closeErrorModal() {
    document.getElementById('errorModal').classList.add('hidden');
}

// Funciones para desbloquear día completo
function unblockFullDay(date) {
    pendingUnblockDate = date;
    // Formatear fecha para mostrar
    const dateObj = new Date(date + 'T12:00:00');
    const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
    const formattedDate = dateObj.toLocaleDateString('es-CL', options);
    document.getElementById('unblockDayDate').textContent = formattedDate;
    document.getElementById('unblockDayModal').classList.remove('hidden');
}

function closeUnblockDayModal() {
    document.getElementById('unblockDayModal').classList.add('hidden');
    pendingUnblockDate = null;
}

function confirmUnblockFullDay() {
    if (!pendingUnblockDate) return;

    const btn = document.getElementById('confirmUnblockBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Desbloqueando...</span>';

    fetch('{% url "forgeapp:unblock_full_day" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `date=${pendingUnblockDate}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else if (data.error) {
            closeUnblockDayModal();
            showError(data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        closeUnblockDayModal();
        showError('Error al procesar la solicitud');
    });
}

// Cerrar modales con tecla Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeBlockDayModal();
        closeUnblockDayModal();
        closeErrorModal();
    }
});
</script>
{% endblock %}
